local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Ustawienia
_G.AutoFarmActive = false -- Domyślnie wyłączone
local toggleKey = Enum.KeyCode.P -- Klawisz aktywacji
local moveSpeed = 25 -- Prędkość (studs per second)

-- Funkcja szukająca najbliższej monety (dynamiczna lokalizacja)
local function getClosestCoin()
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return nil end
    
    local rootPart = character.HumanoidRootPart
    local closestCoin = nil
    local shortestDistance = math.huge

    -- MM2 dynamicznie zmienia kontenery, szukamy najczęstszych nazw
    local potentialFolders = {
        workspace:FindFirstChild("Normal") and workspace.Normal:FindFirstChild("CoinContainer"),
        workspace:FindFirstChild("CoinsHolder"),
        workspace:FindFirstChild("CoinContainer")
    }

    for _, folder in pairs(potentialFolders) do
        if folder then
            for _, coin in pairs(folder:GetChildren()) do
                if coin:IsA("BasePart") or coin:FindFirstChild("TouchInterest") then
                    local distance = (rootPart.Position - coin.Position).Magnitude
                    if distance < shortestDistance then
                        shortestDistance = distance
                        closestCoin = coin
                    end
                end
            end
        end
    end
    return closestCoin
end

-- Funkcja płynnego ruchu
local function moveToCoin(targetCoin)
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local rootPart = character.HumanoidRootPart
    local distance = (rootPart.Position - targetCoin.Position).Magnitude
    local duration = distance / moveSpeed

    local tween = TweenService:Create(rootPart, TweenInfo.new(duration, Enum.EasingStyle.Linear), {CFrame = targetCoin.CFrame})
    
    tween:Play()
    return tween -- Zwracamy tween, żeby móc go przerwać
end

-- Obsługa Toggle
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == toggleKey then
        _G.AutoFarmActive = not _G.AutoFarmActive
        print("AutoFarm status: " .. tostring(_G.AutoFarmActive))
        
        if _G.AutoFarmActive then
            -- Uruchomienie pętli w osobnym wątku
            task.spawn(function()
                while _G.AutoFarmActive do
                    local target = getClosestCoin()
                    if target and target.Parent then
                        local currentTween = moveToCoin(target)
                        
                        -- Czekaj aż moneta zniknie (zostanie zebrana) lub pętla zostanie wyłączona
                        repeat 
                            task.wait(0.1) 
                        until not target.Parent or not _G.AutoFarmActive
                        
                        if currentTween then currentTween:Cancel() end
                    else
                        task.wait(1)
                    end
                end
            end)
        end
    end
end)

print("Skrypt załadowany! Naciśnij 'P', aby przełączyć AutoFarm.")
