local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

_G.Active = false
_G.Running = true
_G.AutoReset = false

local speed = 22
local ignored = {}
local noCoinTime = 0
local RESET_DELAY = 3 -- sekundy bez coinów zanim resetnie

-- GUI
if player.PlayerGui:FindFirstChild("FastFarm") then
    player.PlayerGui.FastFarm:Destroy()
end

local sg = Instance.new("ScreenGui")
sg.Name = "FastFarm"
sg.Parent = player:WaitForChild("PlayerGui")
sg.ResetOnSpawn = false

local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0, 160, 0, 45)
btn.Position = UDim2.new(0.5, -80, 0.05, 0)
btn.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
btn.Text = "FARM: OFF"
btn.TextColor3 = Color3.new(1,1,1)
btn.Font = Enum.Font.SourceSansBold
btn.TextSize = 18
btn.Parent = sg
Instance.new("UICorner", btn)

local resetBtn = Instance.new("TextButton")
resetBtn.Size = UDim2.new(0, 160, 0, 45)
resetBtn.Position = UDim2.new(0.5, -80, 0.05, 55)
resetBtn.BackgroundColor3 = Color3.fromRGB(120,120,120)
resetBtn.Text = "AUTO RESET: OFF"
resetBtn.TextColor3 = Color3.new(1,1,1)
resetBtn.Font = Enum.Font.SourceSansBold
resetBtn.TextSize = 18
resetBtn.Parent = sg
Instance.new("UICorner", resetBtn)

local close = Instance.new("TextButton")
close.Size = UDim2.new(0, 25, 0, 25)
close.Position = UDim2.new(0.5, 90, 0.05, 0)
close.BackgroundColor3 = Color3.fromRGB(200,0,0)
close.Text = "X"
close.TextColor3 = Color3.new(1,1,1)
close.Parent = sg
Instance.new("UICorner", close).CornerRadius = UDim.new(1,0)

-- NOCLIP
RunService.Stepped:Connect(function()
    if _G.Active and player.Character then
        for _,v in pairs(player.Character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = false
            end
        end
    end
end)

-- SPRAWDZANIE CZY SĄ COINY
local function anyCoinsVisible()
    for _,v in pairs(workspace:GetDescendants()) do
        if (v.Name == "Coin" or v.Name == "Coin_Server")
        and v:IsA("BasePart") then
            if v.Transparency < 0.9 and v.CanTouch then
                return true
            end
        end
    end
    return false
end

-- AUTO RESET GDY BRAK COINÓW
task.spawn(function()
    while _G.Running do
        if _G.AutoReset and _G.Active then
            if not anyCoinsVisible() then
                noCoinTime += 0.5
                if noCoinTime >= RESET_DELAY then
                    local char = player.Character
                    local hum = char and char:FindFirstChildOfClass("Humanoid")
                    if hum then
                        hum.Health = 0
                        noCoinTime = 0
                        task.wait(2)
                    end
                end
            else
                noCoinTime = 0
            end
        else
            noCoinTime = 0
        end
        task.wait(0.5)
    end
end)

-- FARM LOGIC
task.spawn(function()
    while _G.Running do
        if _G.Active then
            local char = player.Character
            local root = char and char:FindFirstChild("HumanoidRootPart")

            if root then
                local target = nil
                local dist = math.huge

                for _,v in pairs(workspace:GetDescendants()) do
                    if (v.Name == "Coin" or v.Name == "Coin_Server")
                    and v:IsA("BasePart")
                    and not ignored[v] then
                        local d = (root.Position - v.Position).Magnitude
                        if d < dist then
                            dist = d
                            target = v
                        end
                    end
                end

                if target then
                    local targetPos = target.CFrame * CFrame.new(0,3,0)
                    local tween = TweenService:Create(
                        root,
                        TweenInfo.new(dist/speed, Enum.EasingStyle.Linear),
                        {CFrame = targetPos}
                    )
                    tween:Play()

                    while target
                    and target.Parent
                    and _G.Active
                    and (root.Position - target.Position).Magnitude > 3 do
                        task.wait()
                    end

                    ignored[target] = true
                    tween:Cancel()
                else
                    ignored = {}
                    task.wait(0.1)
                end
            end
        end
        task.wait()
    end
end)

-- BUTTONS
btn.MouseButton1Click:Connect(function()
    _G.Active = not _G.Active
    btn.Text = _G.Active and "FARM: ON" or "FARM: OFF"
    btn.BackgroundColor3 = _G.Active and Color3.fromRGB(50,150,50) or Color3.fromRGB(150,50,50)
    ignored = {}
end)

resetBtn.MouseButton1Click:Connect(function()
    _G.AutoReset = not _G.AutoReset
    resetBtn.Text = _G.AutoReset and "AUTO RESET: ON" or "AUTO RESET: OFF"
    resetBtn.BackgroundColor3 = _G.AutoReset and Color3.fromRGB(50,150,50) or Color3.fromRGB(120,120,120)
end)

close.MouseButton1Click:Connect(function()
    _G.Active = false
    _G.Running = false
    sg:Destroy()
end)
