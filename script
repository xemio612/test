local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

_G.Active = false
_G.Running = true 
_G.UseTween = true 
local speed = 22 
local ignored = {}

-- Funkcja pomocnicza do pobierania aktualnego RootPart
local function getRoot()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart", 5)
end

-- GUI
if player.PlayerGui:FindFirstChild("FastFarm") then
    player.PlayerGui.FastFarm:Destroy()
end

local sg = Instance.new("ScreenGui")
sg.Name = "FastFarm"
sg.Parent = player:WaitForChild("PlayerGui")
sg.ResetOnSpawn = false

local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0, 160, 0, 45)
btn.Position = UDim2.new(0.5, -80, 0.05, 0)
btn.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
btn.Text = "FARM: OFF"
btn.TextColor3 = Color3.new(1,1,1)
btn.Font = Enum.Font.SourceSansBold
btn.TextSize = 18
btn.Parent = sg
Instance.new("UICorner", btn)

local modeBtn = Instance.new("TextButton")
modeBtn.Size = UDim2.new(0, 160, 0, 35)
modeBtn.Position = UDim2.new(0.5, -80, 0.05, 50)
modeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 160)
modeBtn.Text = "MODE: TWEEN"
modeBtn.TextColor3 = Color3.new(1,1,1)
modeBtn.Font = Enum.Font.SourceSansBold
modeBtn.TextSize = 16
modeBtn.Parent = sg
Instance.new("UICorner", modeBtn)

local close = Instance.new("TextButton")
close.Size = UDim2.new(0, 25, 0, 25)
close.Position = UDim2.new(0.5, 90, 0.05, 0)
close.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
close.Text = "X"
close.TextColor3 = Color3.new(1,1,1)
close.Parent = sg
Instance.new("UICorner", close).CornerRadius = UDim.new(1,0)

-- NOCLIP (z poprawionym sprawdzaniem postaci)
RunService.Stepped:Connect(function()
    if _G.Active and player.Character then
        for _, v in pairs(player.Character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = false
            end
        end
    end
end)

-- LOGIKA FARMU
task.spawn(function()
    while _G.Running do
        if _G.Active then
            local root = getRoot() -- Pobieramy świeży RootPart w każdej iteracji
            
            if root and root.Parent then
                local target = nil
                local dist = math.huge

                -- Szukanie najbliższego coina
                for _, v in pairs(workspace:GetDescendants()) do
                    if (v.Name == "Coin_Server" or v.Name == "Coin")
                        and v:IsA("BasePart")
                        and not ignored[v] then
                        local d = (root.Position - v.Position).Magnitude
                        if d < dist then
                            dist = d
                            target = v
                        end
                    end
                end

                if target and target.Parent then
                    local targetCF = target.CFrame * CFrame.new(0, 3, 0)

                    if _G.UseTween then
                        -- TWEEN
                        local tween = TweenService:Create(
                            root,
                            TweenInfo.new(dist / speed, Enum.EasingStyle.Linear),
                            {CFrame = targetCF}
                        )
                        tween:Play()

                        -- Czekaj aż doleci, ale przerwij jeśli postać padnie lub wyłączysz farmę
                        while target and target.Parent and _G.Active and root and root.Parent
                            and (root.Position - target.Position).Magnitude > 2.5 do
                            task.wait()
                        end

                        ignored[target] = true
                        tween:Cancel()
                    else
                        -- TELEPORT (z czekaniem)
                        task.wait(dist / speed)

                        -- Sprawdzamy ponownie czy root i target istnieją po czekaniu
                        if target and target.Parent and _G.Active and root and root.Parent then
                            root.CFrame = targetCF
                            ignored[target] = true
                        end
                    end
                else
                    ignored = {} -- Reset listy zignorowanych jeśli nie ma celów
                    task.wait(0.5)
                end
            end
        end
        task.wait(0.1)
    end
end)

-- PRZYCISKI
btn.MouseButton1Click:Connect(function()
    _G.Active = not _G.Active
    btn.Text = _G.Active and "FARM: ON" or "FARM: OFF"
    btn.BackgroundColor3 = _G.Active
        and Color3.fromRGB(50,150,50)
        or Color3.fromRGB(150,50,50)
    if _G.Active then
        ignored = {}
    end
end)

modeBtn.MouseButton1Click:Connect(function()
    _G.UseTween = not _G.UseTween
    modeBtn.Text = _G.UseTween and "MODE: TWEEN" or "MODE: TELEPORT"
    modeBtn.BackgroundColor3 = _G.UseTween
        and Color3.fromRGB(60,60,160)
        or Color3.fromRGB(160,150,0)
end)

close.MouseButton1Click:Connect(function()
    _G.Active = false
    _G.Running = false
    sg:Destroy()
end)
