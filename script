local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer

-- Zmienne systemowe
_G.FarmActive = false
_G.AutoReset = false
_G.FlySpeed = 20
_G.Running = true
local ignoredCoins = {}

-- USUWANIE POPRZEDNICH WERSJI (żeby się nie nakładały)
local oldUI = player.PlayerGui:FindFirstChild("CustomMM2_Hub")
if oldUI then oldUI:Destroy() end

-- STWORZENIE INTERFEJSU (Zmienione na PlayerGui)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CustomMM2_Hub"
ScreenGui.Parent = player:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false -- Ważne: GUI nie zniknie po śmierci

local Main = Instance.new("Frame")
Main.Name = "Main"
Main.Parent = ScreenGui
Main.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
Main.Position = UDim2.new(0.5, -110, 0.5, -140) -- ŚRODEK EKRANU
Main.Size = UDim2.new(0, 220, 0, 280)
Main.Active = true
Main.Draggable = true 

local UICorner = Instance.new("UICorner")
UICorner.Parent = Main

local Title = Instance.new("TextLabel")
Title.Parent = Main
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
Title.Text = "MM2 FIX HUB"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
Instance.new("UICorner", Title)

local Close = Instance.new("TextButton")
Close.Parent = Main
Close.Position = UDim2.new(0.85, 0, 0.02, 0)
Close.Size = UDim2.new(0, 25, 0, 25)
Close.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
Close.Text = "X"
Close.TextColor3 = Color3.fromRGB(255, 255, 255)
Instance.new("UICorner", Close).CornerRadius = UDim.new(1, 0)

-- PRZYCISKI
local function createBtn(text, pos)
    local btn = Instance.new("TextButton")
    btn.Parent = Main
    btn.Position = pos
    btn.Size = UDim2.new(0.8, 0, 0, 35)
    btn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Font = Enum.Font.Gotham
    Instance.new("UICorner", btn)
    return btn
end

local FarmBtn = createBtn("START FARM", UDim2.new(0.1, 0, 0.2, 0))
local ResetBtn = createBtn("AUTO-RESET: OFF", UDim2.new(0.1, 0, 0.35, 0))

-- SUWAK
local SliderLabel = Instance.new("TextLabel")
SliderLabel.Parent = Main
SliderLabel.Position = UDim2.new(0, 0, 0.55, 0)
SliderLabel.Size = UDim2.new(1, 0, 0, 20)
SliderLabel.BackgroundTransparency = 1
SliderLabel.Text = "Speed: 20 studs/s"
SliderLabel.TextColor3 = Color3.fromRGB(255, 255, 255)

local SliderBack = Instance.new("Frame")
SliderBack.Parent = Main
SliderBack.Position = UDim2.new(0.1, 0, 0.65, 0)
SliderBack.Size = UDim2.new(0.8, 0, 0, 6)
SliderBack.BackgroundColor3 = Color3.fromRGB(80, 80, 90)

local SliderDot = Instance.new("TextButton")
SliderDot.Parent = SliderBack
SliderDot.Size = UDim2.new(0, 15, 0, 15)
SliderDot.Position = UDim2.new(0.5, -7, -0.7, 0)
SliderDot.BackgroundColor3 = Color3.fromRGB(120, 150, 255)
SliderDot.Text = ""
Instance.new("UICorner", SliderDot)

-- LOGIKA NOCLIP
RunService.Stepped:Connect(function()
    if _G.FarmActive and player.Character then
        for _, v in pairs(player.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
    end
end)

-- LOGIKA SZUKANIA MONET
local function getCoin()
    local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    local closest, dist = nil, math.huge
    for _, v in pairs(workspace:GetDescendants()) do
        if (v.Name == "Coin_Server" or v.Name == "Coin") and v:IsA("BasePart") and not ignoredCoins[v] then
            local d = (root.Position - v.Position).Magnitude
            if d < dist then dist = d; closest = v end
        end
    end
    return closest
end

-- PĘTLA
task.spawn(function()
    while _G.Running do
        if _G.FarmActive then
            local target = getCoin()
            local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if target and root then
                local duration = (root.Position - target.Position).Magnitude / _G.FlySpeed
                local tween = TweenService:Create(root, TweenInfo.new(duration, Enum.EasingStyle.Linear), {CFrame = target.CFrame})
                tween:Play()
                repeat task.wait() until not target or not target.Parent or not _G.FarmActive or (root.Position - target.Position).Magnitude < 2.5
                if target then ignoredCoins[target] = true end
                tween:Cancel()
            else
                ignoredCoins = {}
                task.wait(1)
            end
        end
        task.wait()
    end
end)

-- OBSŁUGA
FarmBtn.MouseButton1Click:Connect(function()
    _G.FarmActive = not _G.FarmActive
    FarmBtn.Text = _G.FarmActive and "STOP FARM" or "START FARM"
    FarmBtn.BackgroundColor3 = _G.FarmActive and Color3.fromRGB(60, 150, 60) or Color3.fromRGB(50, 50, 60)
end)

ResetBtn.MouseButton1Click:Connect(function()
    _G.AutoReset = not _G.AutoReset
    ResetBtn.Text = _G.AutoReset and "AUTO-RESET: ON" or "AUTO-RESET: OFF"
end)

local dragging = false
SliderDot.MouseButton1Down:Connect(function() dragging = true end)
UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local pos = math.clamp((input.Position.X - SliderBack.AbsolutePosition.X) / SliderBack.AbsoluteSize.X, 0, 1)
        SliderDot.Position = UDim2.new(pos, -7, -0.7, 0)
        _G.FlySpeed = 15 + (pos * 10)
        SliderLabel.Text = "Speed: " .. math.floor(_G.FlySpeed) .. " studs/s"
    end
end)

Close.MouseButton1Click:Connect(function()
    _G.Running = false
    _G.FarmActive = false
    ScreenGui:Destroy()
end)

print("MM2 Hub załadowany pomyślnie!")
