local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer

-- Zmienne systemowe
_G.FarmActive = false
_G.AutoReset = false
_G.FlySpeed = 20
_G.Running = true
local ignoredCoins = {}

-- STWORZENIE INTERFEJSU
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CustomMM2_Hub"
ScreenGui.Parent = game.CoreGui
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local Main = Instance.new("Frame")
Main.Name = "Main"
Main.Parent = ScreenGui
Main.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
Main.Position = UDim2.new(0.3, 0, 0.3, 0)
Main.Size = UDim2.new(0, 220, 0, 280)
Main.Active = true
Main.Draggable = true -- Możesz przesuwać okno

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = Main

local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Parent = Main
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
Title.Text = "MM2 CUSTOM HUB"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
local TitleCorner = Instance.new("UICorner")
TitleCorner.Parent = Title

local Close = Instance.new("TextButton")
Close.Name = "Close"
Close.Parent = Main
Close.Position = UDim2.new(0.85, 0, 0.02, 0)
Close.Size = UDim2.new(0, 25, 0, 25)
Close.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
Close.Text = "X"
Close.TextColor3 = Color3.fromRGB(255, 255, 255)
local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(1, 0)
CloseCorner.Parent = Close

-- PRZYCISK: AUTO FARM
local FarmBtn = Instance.new("TextButton")
FarmBtn.Parent = Main
FarmBtn.Position = UDim2.new(0.1, 0, 0.2, 0)
FarmBtn.Size = UDim2.new(0.8, 0, 0, 35)
FarmBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
FarmBtn.Text = "AUTO-FARM: OFF"
FarmBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
FarmBtn.Font = Enum.Font.Gotham
Instance.new("UICorner", FarmBtn)

-- PRZYCISK: AUTO RESET
local ResetBtn = Instance.new("TextButton")
ResetBtn.Parent = Main
ResetBtn.Position = UDim2.new(0.1, 0, 0.35, 0)
ResetBtn.Size = UDim2.new(0.8, 0, 0, 35)
ResetBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
ResetBtn.Text = "AUTO-RESET: OFF"
ResetBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
ResetBtn.Font = Enum.Font.Gotham
Instance.new("UICorner", ResetBtn)

-- SUWAK PRĘDKOŚCI
local SliderTitle = Instance.new("TextLabel")
SliderTitle.Parent = Main
SliderTitle.Position = UDim2.new(0.1, 0, 0.55, 0)
SliderTitle.Size = UDim2.new(0.8, 0, 0, 20)
SliderTitle.BackgroundTransparency = 1
SliderTitle.Text = "Speed: 20 studs/s"
SliderTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
SliderTitle.Font = Enum.Font.Gotham

local SliderBack = Instance.new("Frame")
SliderBack.Parent = Main
SliderBack.Position = UDim2.new(0.1, 0, 0.65, 0)
SliderBack.Size = UDim2.new(0.8, 0, 0, 6)
SliderBack.BackgroundColor3 = Color3.fromRGB(60, 60, 65)

local SliderDot = Instance.new("TextButton")
SliderDot.Parent = SliderBack
SliderDot.Size = UDim2.new(0, 15, 0, 15)
SliderDot.Position = UDim2.new(0.5, -7, -0.7, 0)
SliderDot.BackgroundColor3 = Color3.fromRGB(100, 150, 255)
SliderDot.Text = ""
Instance.new("UICorner", SliderDot)

-- LOGIKA NOCLIP
RunService.Stepped:Connect(function()
    if _G.FarmActive and player.Character then
        for _, part in pairs(player.Character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
    end
end)

-- LOGIKA SPRAWDZANIA WORKA
local function isFull()
    local gui = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("MainGui")
    if gui and gui:FindFirstChild("Game") and gui.Game:FindFirstChild("CoinBackpack") then
        return gui.Game.CoinBackpack:FindFirstChild("Full") and gui.Game.CoinBackpack.Full.Visible
    end
    return false
end

-- LOGIKA SZUKANIA MONET
local function getCoin()
    local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    local closest, dist = nil, math.huge
    for _, v in pairs(workspace:GetDescendants()) do
        if (v.Name == "Coin_Server" or v.Name == "Coin") and v:IsA("BasePart") and not ignoredCoins[v] then
            local d = (root.Position - v.Position).Magnitude
            if d < dist then dist = d; closest = v end
        end
    end
    return closest
end

-- PĘTLA GŁÓWNA
task.spawn(function()
    while _G.Running do
        if _G.FarmActive then
            if _G.AutoReset and isFull() then
                if player.Character then player.Character:BreakJoints() end
                task.wait(5)
            end
            
            local target = getCoin()
            local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if target and root then
                local duration = (root.Position - target.Position).Magnitude / _G.FlySpeed
                local tween = TweenService:Create(root, TweenInfo.new(duration, Enum.EasingStyle.Linear), {CFrame = target.CFrame})
                tween:Play()
                repeat task.wait() until not target or not target.Parent or not _G.FarmActive or (root.Position - target.Position).Magnitude < 2.5
                if target then ignoredCoins[target] = true end
                tween:Cancel()
            else
                ignoredCoins = {} -- Resetuj listę gdy pusto
                task.wait(1)
            end
        end
        task.wait()
    end
end)

-- OBSŁUGA PRZYCISKÓW I SUWAKA
FarmBtn.MouseButton1Click:Connect(function()
    _G.FarmActive = not _G.FarmActive
    FarmBtn.Text = _G.FarmActive and "AUTO-FARM: ON" or "AUTO-FARM: OFF"
    FarmBtn.BackgroundColor3 = _G.FarmActive and Color3.fromRGB(60, 150, 60) or Color3.fromRGB(50, 50, 55)
end)

ResetBtn.MouseButton1Click:Connect(function()
    _G.AutoReset = not _G.AutoReset
    ResetBtn.Text = _G.AutoReset and "AUTO-RESET: ON" or "AUTO-RESET: OFF"
    ResetBtn.BackgroundColor3 = _G.AutoReset and Color3.fromRGB(60, 100, 150) or Color3.fromRGB(50, 50, 55)
end)

local dragSlider = false
SliderDot.MouseButton1Down:Connect(function() dragSlider = true end)
UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragSlider = false end end)
UserInputService.InputChanged:Connect(function(input)
    if dragSlider and input.UserInputType == Enum.UserInputType.MouseMovement then
        local pos = math.clamp((input.Position.X - SliderBack.AbsolutePosition.X) / SliderBack.AbsoluteSize.X, 0, 1)
        SliderDot.Position = UDim2.new(pos, -7, -0.7, 0)
        _G.FlySpeed = 15 + (pos * 10) -- 15 do 25
        SliderTitle.Text = "Speed: " .. math.floor(_G.FlySpeed) .. " studs/s"
    end
end)

Close.MouseButton1Click:Connect(function()
    _G.Running = false
    _G.FarmActive = false
    ScreenGui:Destroy()
end)
