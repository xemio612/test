-- SERVICES
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

-- GLOBALS
_G.Active = false
_G.Running = true
_G.AutoReset = true

local speed = 22
local coinCount = 0
local ignored = {}

-- GUI CLEANUP
if player.PlayerGui:FindFirstChild("FastFarm") then
	player.PlayerGui.FastFarm:Destroy()
end

-- SCREEN GUI
local sg = Instance.new("ScreenGui")
sg.Name = "FastFarm"
sg.Parent = player.PlayerGui
sg.ResetOnSpawn = false

-- MAIN FRAME
local main = Instance.new("Frame", sg)
main.Size = UDim2.new(0,260,0,300)
main.Position = UDim2.new(0.5,-130,0.5,-150)
main.BackgroundColor3 = Color3.fromRGB(18,18,18)
main.Active = true
Instance.new("UICorner", main).CornerRadius = UDim.new(0,16)

local stroke = Instance.new("UIStroke", main)
stroke.Thickness = 1.5
stroke.Color = Color3.fromRGB(70,70,70)

local grad = Instance.new("UIGradient", main)
grad.Color = ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(40,40,40)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(10,10,10))
}

-- DRAG
do
	local dragging, dragStart, startPos
	main.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = i.Position
			startPos = main.Position
		end
	end)
	UserInputService.InputChanged:Connect(function(i)
		if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
			local d = i.Position - dragStart
			main.Position = UDim2.new(
				startPos.X.Scale, startPos.X.Offset + d.X,
				startPos.Y.Scale, startPos.Y.Offset + d.Y
			)
		end
	end)
	UserInputService.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)
end

-- TITLE
local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1,-60,0,40)
title.Position = UDim2.new(0,20,0,10)
title.Text = "EXOTIC HUB"
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1
title.TextXAlignment = Left

-- CLOSE
local close = Instance.new("TextButton", main)
close.Size = UDim2.new(0,28,0,28)
close.Position = UDim2.new(1,-38,0,12)
close.Text = "X"
close.Font = Enum.Font.GothamBold
close.TextSize = 16
close.TextColor3 = Color3.new(1,1,1)
close.BackgroundColor3 = Color3.fromRGB(200,50,50)
Instance.new("UICorner", close).CornerRadius = UDim.new(1,0)

close.MouseButton1Click:Connect(function()
	_G.Active = false
	_G.Running = false
	sg:Destroy()
end)

-- TOGGLE CREATOR
local function createToggle(text, y, default, callback)
	local holder = Instance.new("Frame", main)
	holder.Size = UDim2.new(1,-40,0,40)
	holder.Position = UDim2.new(0,20,0,y)
	holder.BackgroundTransparency = 1

	local label = Instance.new("TextLabel", holder)
	label.Size = UDim2.new(1,-60,1,0)
	label.Text = text
	label.Font = Enum.Font.GothamBold
	label.TextSize = 16
	label.TextColor3 = Color3.new(1,1,1)
	label.BackgroundTransparency = 1
	label.TextXAlignment = Left

	local toggle = Instance.new("Frame", holder)
	toggle.Size = UDim2.new(0,36,0,20)
	toggle.Position = UDim2.new(1,-36,0.5,-10)
	toggle.BackgroundColor3 = default and Color3.fromRGB(0,200,0) or Color3.fromRGB(200,0,0)
	Instance.new("UICorner", toggle).CornerRadius = UDim.new(1,0)

	local hit = Instance.new("TextButton", toggle)
	hit.Size = UDim2.new(1,0,1,0)
	hit.Text = ""
	hit.BackgroundTransparency = 1

	local state = default
	hit.MouseButton1Click:Connect(function()
		state = not state
		TweenService:Create(toggle, TweenInfo.new(0.15),
			{BackgroundColor3 = state and Color3.fromRGB(0,200,0) or Color3.fromRGB(200,0,0)}
		):Play()
		callback(state)
	end)
end

createToggle("Auto Farm", 70, false, function(v)
	_G.Active = v
end)

createToggle("Reset When Full Bag", 120, true, function(v)
	_G.AutoReset = v
end)

-- SPEED
local speedTitle = Instance.new("TextLabel", main)
speedTitle.Size = UDim2.new(1,0,0,30)
speedTitle.Position = UDim2.new(0,0,0,170)
speedTitle.Text = "Farm Speed"
speedTitle.Font = Enum.Font.GothamBold
speedTitle.TextSize = 18
speedTitle.TextColor3 = Color3.new(1,1,1)
speedTitle.BackgroundTransparency = 1

local sliderBar = Instance.new("Frame", main)
sliderBar.Size = UDim2.new(1,-60,0,6)
sliderBar.Position = UDim2.new(0,30,0,215)
sliderBar.BackgroundColor3 = Color3.fromRGB(80,80,80)
Instance.new("UICorner", sliderBar).CornerRadius = UDim.new(1,0)

local knob = Instance.new("Frame", sliderBar)
knob.Size = UDim2.new(0,14,0,14)
knob.Position = UDim2.new((speed-15)/10,-7,0.5,-7)
knob.BackgroundColor3 = Color3.fromRGB(230,230,230)
Instance.new("UICorner", knob).CornerRadius = UDim.new(1,0)

local value = Instance.new("TextLabel", main)
value.Size = UDim2.new(1,0,0,20)
value.Position = UDim2.new(0,0,0,235)
value.Text = tostring(speed)
value.Font = Enum.Font.GothamBold
value.TextSize = 14
value.TextColor3 = Color3.new(1,1,1)
value.BackgroundTransparency = 1

local dragging = false
knob.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
	end
end)
UserInputService.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)
UserInputService.InputChanged:Connect(function(i)
	if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
		local x = math.clamp(
			(UserInputService:GetMouseLocation().X - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X,
			0,1
		)
		speed = math.floor(15 + x*10)
		knob.Position = UDim2.new(x,-7,0.5,-7)
		value.Text = tostring(speed)
	end
end)

-- NOCLIP
RunService.Stepped:Connect(function()
	if _G.Active and player.Character then
		for _,v in pairs(player.Character:GetDescendants()) do
			if v:IsA("BasePart") then
				v.CanCollide = false
			end
		end
	end
end)

-- COIN TOUCH
local function setupTouch(char)
	local root = char:WaitForChild("HumanoidRootPart")
	root.Touched:Connect(function(hit)
		if _G.Active and (hit.Name == "Coin" or hit.Name == "Coin_Server") and not ignored[hit] then
			ignored[hit] = true
			coinCount += 1
		end
	end)
end

if player.Character then
	setupTouch(player.Character)
end

player.CharacterAdded:Connect(function(char)
	coinCount = 0
	ignored = {}
	setupTouch(char)
end)

-- FARM LOOP
task.spawn(function()
	while _G.Running do
		if _G.Active then
			if _G.AutoReset and coinCount >= 40 then
				_G.Active = false
				player.Character.Humanoid.Health = 0
				player.CharacterAdded:Wait()
				task.wait(1)
				_G.Active = true
			end

			local char = player.Character
			local root = char and char:FindFirstChild("HumanoidRootPart")
			if root then
				local target, dist = nil, math.huge
				for _,v in pairs(workspace:GetDescendants()) do
					if (v.Name=="Coin" or v.Name=="Coin_Server")
						and v:IsA("BasePart")
						and not ignored[v] then

						local d = (root.Position - v.Position).Magnitude
						if d < dist then
							dist = d
							target = v
						end
					end
				end

				if target then
					local tween = TweenService:Create(
						root,
						TweenInfo.new(dist/speed, Enum.EasingStyle.Linear),
						{CFrame = target.CFrame * CFrame.new(0,3,0)}
					)
					tween:Play()

					while _G.Active and target.Parent
						and (root.Position - target.Position).Magnitude > 2 do
						task.wait()
					end

					tween:Cancel()
					ignored[target] = true
				else
					ignored = {}
					task.wait(0.1)
				end
			end
		end
		task.wait()
	end
end)
